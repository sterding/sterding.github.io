---
layout: post
title: get UCSC images for a list of regions in batch
date: '2012-07-24T14:58:00.000-04:00'
author: Xianjun Dong
tags:
- UCSC
- R
modified_time: '2012-07-24T14:58:16.303-04:00'
blogger_id: tag:blogger.com,1999:blog-12445049.post-4380880814568922648
blogger_orig_url: http://onetipperday.blogspot.com/2012/07/get-ucsc-images-for-list-of-regions-in.html
---

<br /><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">Here is my working R code for the task. It can be simplified as 3 lines.</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"><br /></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"><br /></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"># example of controling individual track</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">#theURL="<a href="http://genome.ucsc.edu/cgi-bin/hgTracks?db=mm9&amp;wgRna=hide&amp;cpgIslandExt=pack&amp;ensGene=hide&amp;mrna=hide&amp;intronEst=hide&amp;mgcGenes=hide&amp;hgt.psOutput=on&amp;cons44way=hide&amp;snp130=hide&amp;snpArray=hide&amp;wgEncodeReg=hide&amp;pix=1000&amp;refGene=pack&amp;knownGene=hide&amp;rmsk=hide" style="color: #1155cc;" target="_blank">http://genome.ucsc.<wbr></wbr>edu/cgi-bin/hgTracks?db=mm9&amp;<wbr></wbr>wgRna=hide&amp;cpgIslandExt=pack&amp;<wbr></wbr>ensGene=hide&amp;mrna=hide&amp;<wbr></wbr>intronEst=hide&amp;mgcGenes=hide&amp;<wbr></wbr>hgt.psOutput=on&amp;cons44way=<wbr></wbr>hide&amp;snp130=hide&amp;snpArray=<wbr></wbr>hide&amp;wgEncodeReg=hide&amp;pix=<wbr></wbr>1000&amp;refGene=pack&amp;knownGene=<wbr></wbr>hide&amp;rmsk=hide</a>"</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"># example of controling via session</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">theURL="<a href="http://genome-preview.ucsc.edu/cgi-bin/hgTracks?hgS_doOtherUser=submit&amp;hgS_otherUserName=sterding&amp;hgS_otherUserSessionName=mm9_piRNA&amp;hgt.psOutput=on&amp;pix=1000" style="color: #1155cc;" target="_blank">http://genome-preview.<wbr></wbr>ucsc.edu/cgi-bin/hgTracks?hgS_<wbr></wbr>doOtherUser=submit&amp;hgS_<wbr></wbr>otherUserName=sterding&amp;hgS_<wbr></wbr>otherUserSessionName=mm9_<wbr></wbr>piRNA&amp;hgt.psOutput=on&amp;pix=1000</a><wbr></wbr>"</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"><br /></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"># read regions</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">toPlot=read.table("../data/<wbr></wbr>piRNA.clusters.coordinates.<wbr></wbr>cpg.bed", header=T)</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"><br /></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">## paralle version</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">#&nbsp;<span style="background-color: white;">library(multicore)</span></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"># mclapply(1:nrow(toPlot), function(i) screenshotUCSC(theURL, "", as.character(toPlot$chr[i]), toPlot$start[i]-2000, toPlot$end[i]+1999, paste("region_", i, "_", toPlot$name[i],".pdf", sep="")), mc.cores=10)</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"><br /></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"># anti-robot version&nbsp;</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"># UCSC Policy:&nbsp;<span style="background-color: white;">Program-driven use of this software is limited to a maximum of one hit every 15 seconds and no more than 5,000 hits per day.</span></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">for(i in 1:nrow(toPlot)){</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; screenshotUCSC(theURL, "", as.character(toPlot$chr[i]), toPlot$start[i]-2000, toPlot$end[i]+1999, paste("region_", i, "_", toPlot$name[i],".pdf", sep=""))</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; Sys.sleep(5)&nbsp;</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">}</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"><br /></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"># merge script</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">mergePDF("piRNAs_ucsc_<wbr></wbr>screeshot.pdf", list.files(pattern="region_.*.<wbr></wbr>pdf"))</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">try(system("rm region_.*.pdf"))</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"><br /></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">####### lib ############</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"><br /></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"># Here is an R script wrote by Aaron Statham which saves UCSC to pdfs -</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"># you can choose which genome and tracks to display by altering the 'url' parameter. 'trackfile' is the url of a file describing the custom tracks (beds/bigwigs) to display</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">mergePDF &lt;- function(output="merged.pdf", sourcefiles=c("source1.pdf","<wbr></wbr>source2.pdf","source3.pdf"))</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">{</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; # create the command string and call the command using system()</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; # merging command from&nbsp;<a href="http://hints.macworld.com/article.php?story=2003083122212228" style="color: #1155cc;" target="_blank">http://hints.macworld.com/<wbr></wbr>article.php?story=<wbr></wbr>2003083122212228</a></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; command=paste("gs -q -dNOPAUSE -dBATCH -sDEVICE=pdfwrite",paste("-<wbr></wbr>sOutputFile",output, sep="="), paste(sourcefiles, collapse=" "),sep=" ")</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; try(system(command))</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">}</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"><br /></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"><br /></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;"># &nbsp;Reference:&nbsp;<a href="http://www.biostars.org/post/show/6132/batch-viewing-of-ucsc-browser-graphic/" style="color: #1155cc;" target="_blank">http://www.biostars.org/post/<wbr></wbr>show/6132/batch-viewing-of-<wbr></wbr>ucsc-browser-graphic/</a></div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">screenshotUCSC &lt;- function(url, trackfile, chr, start, end, filename) {</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; &nbsp; &nbsp; oldpen &lt;- options("scipen")</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; &nbsp; &nbsp; options(scipen=100)</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; &nbsp; &nbsp; temp &lt;- readLines(paste(url, "&amp;hgt.customText=", trackfile, "&amp;position=",chr,":",start,"-"<wbr></wbr>,end, sep=""))</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; &nbsp; &nbsp; #cat(temp,"\n")</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; &nbsp; &nbsp; pdfurl &lt;- paste("<a href="http://genome-preview.ucsc.edu/trash" style="color: #1155cc;" target="_blank">http://genome-preview.<wbr></wbr>ucsc.edu/trash</a>",gsub(".*trash"<wbr></wbr>,"",gsub(".pdf.*","",temp[<wbr></wbr>grep(".pdf", temp, fixed=TRUE)][1])), ".pdf", sep="")</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; &nbsp; &nbsp; cat(pdfurl,"\n");</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; &nbsp; &nbsp; options(scipen=oldpen)</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">&nbsp; &nbsp; &nbsp; &nbsp; download.file(pdfurl, filename, mode="wb", quiet=TRUE)</div><div style="color: #222222; font-family: arial, sans-serif; font-size: 12.800000190734863px;">}</div>