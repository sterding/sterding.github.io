---
layout: post
title: awk script to correct XS:A tag of Tophat output for strand-specific paired-end
  reads
date: '2012-08-10T15:24:00.000-04:00'
author: Xianjun Dong
tags:
- next-generation sequencing
- awk
- bioinformatics
- Tophat
modified_time: '2012-08-10T15:24:24.986-04:00'
blogger_id: tag:blogger.com,1999:blog-12445049.post-4012264149006653749
blogger_orig_url: http://onetipperday.blogspot.com/2012/08/awk-script-to-correct-xsa-tag-of-tophat.html
---

It's been noticed that the current Tophat (v2.0.3) can assign wrong XS:A tag&nbsp;for strand-specific paired-end library,&nbsp;at least for some reads. Here is such an example:<br /><br /><span style="font-family: Courier New, Courier, monospace;">HWI-ST560:74:D14ELACXX:4:1201:8827:168386 pr1 chr1 10024104 50 50M = 10020756 -3398 TGGTTCTTGAAACTGCTGGTTCAGCATCTGTGTACTAACATCAATCCCGG IJJJJJJJIIIGJJJJJJJJJJJJJJJJJJJJIJJJJHHHHHFFFFFCCC AS:i:0 XN:i:0 XM:i:0 XO:i:0 XG:i:0 NM:i:0 MD:Z:50 YT:Z:UU NH:i:1 XS:A:+<br />HWI-ST560:74:D14ELACXX:4:1201:8827:168386 pR2 chr1 10020756 50 36M1628N14M = 10024104 3398 GATGATTTGAAATATGAGACTTCTAAGGCATAATATTGTTTGCAGTGCAC CCCFFFFFHHHHHJJJJJJJJJJJJJJJJJJJJIIIIJJJJIJIJHJGEC AS:i:0 XM:i:0 XO:i:0 XG:i:0 MD:Z:50 NM:i:0 XS:A:- NH:i:1</span><br /><br />This is a dUTP protocol where "R2/r1" FLAG for the read pair indicate the reads are a transcript on the + strand, which means both reads should be assigned as XS:A:+. However /2 is assigned to XS:A:-. <br /><br />I've written an awk script to solve the problem:<br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><div><span style="font-family: Courier New, Courier, monospace;">#!/bin/awk -f</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">BEGIN{</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; if(save_discrepancy_to_file!="") system("[ -e " save_discrepancy_to_file " ] &amp;&amp; rm " save_discrepancy_to_file);</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div><div><span style="font-family: Courier New, Courier, monospace;">{</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; if($1 ~ /^@/) print;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; else</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; {</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; for(i=1;i&lt;=NF;i++) if($i!~/^XS/) printf("%s\t",$i); else XS0=$i;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; XS1=XS0;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; if($2~/^0x/ || $2~/^[0-9]+$/){ &nbsp; # FLAG in HEX or Decimal format</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(libtype=="fr-firststrand") XS1=((and($2, 0x10) &amp;&amp; and($2, 0x40)) || (and($2,0x80) &amp;&amp; !and($2,0x10)))?"XS:A:+":"XS:A:-";</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(libtype=="fr-secondstrand") XS1=((and($2, 0x10) &amp;&amp; and($2, 0x80)) || (and($2,0x40) &amp;&amp; !and($2,0x10)))?"XS:A:+":"XS:A:-";</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; else if($2~/^[:alpha:]/){ &nbsp; # FLAG in string</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(libtype=="fr-firststrand") XS1=($2~/r.*1/ || ($2~/2/ &amp;&amp; $2!~/r/))?"XS:A:+":"XS:A:-";</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(libtype=="fr-secondstrand") XS1=($2~/r.*2/|| ($2~/1/ &amp;&amp; $2!~/r/))?"XS:A:+":"XS:A:-";</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; }</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; print XS1;</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; if(save_discrepancy_to_file!="" &amp;&amp; XS1!=XS0) print &gt;&gt; save_discrepancy_to_file;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; }</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div>